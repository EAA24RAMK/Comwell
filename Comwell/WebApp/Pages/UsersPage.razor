@page "/users"
@using Core.Models
@using WebApp.Services
@inject IUserService UserService
@inject NavigationManager Nav

<h3>Brugere</h3>

<div class="filters">
    <input type="text" @bind="searchTerm" @bind:event="oninput" placeholder="Søg efter bruger..." />
    <select @bind="selectedRole">
        <option value="">Alle roller</option>
        @foreach (var role in Roles)
        {
            <option value="@role">@role</option>
        }
    </select>
    <select @bind="selectedHotel">
        <option value="">Alle lokationer</option>
        @foreach (var hotel in hotels)
        {
            <option value="@hotel">@hotel</option>
        }
    </select>
    @if (currentUser?.Role == "HR")
    {
        <button @onclick="CreateUser">+ Tilføj bruger</button>
    }
</div>

<div class="user-list">
    <div class="user-card user-header">
        <div></div>
        <div class="header-label">Bruger</div>
        <div class="header-label">Skole</div>
        <div class="header-label">Lokation</div>
        <div class="header-label">Status</div>
        <div></div>
    </div>

    @foreach (var user in FilteredUsers)
    {
        <div class="user-card">
            <div class="avatar">@GetInitials(user.Name)</div>
            <div class="user-info">
                <div class="user-name">@user.Name</div>
                <div class="user-role">@user.Role</div>
            </div>
            <div class="user-school">
                @(string.IsNullOrWhiteSpace(user.SchoolType) ? "-" : user.SchoolType)
            </div>
            <div class="user-location">
                @(string.IsNullOrWhiteSpace(user.Hotel) ? "-" : user.Hotel)
            </div>
            <div class="user-status @(user.Status == "Aktiv" ? "active" : "inactive")">
                @user.Status
            </div>
            <div class="user-actions">
                @if (currentUser?.Role == "HR")
                {
                    <button @onclick="() => ToggleActionMenu(user.Id)">⋮</button>
                    @if (activeActionMenuUserId == user.Id)
                    {
                        <div class="action-menu">
                            <button class="action-button" @onclick="() => ToggleUserStatusAsync(user)">
                                @(user.Status == "Aktiv" ? "Gør inaktiv" : "Gør aktiv")
                            </button>
                            <button class="action-button delete-button" @onclick="() => DeleteUserAsync(user.Id)">
                                Slet
                            </button>
                        </div>
                    }
                }
            </div>
        </div>
    }
</div>

@if (showCreateModal)
{
    <div class="modal-background">
        <div class="modal-box">
            <h5>Opret ny bruger</h5>
            <input @bind="newUser.Name" placeholder="Navn" />
            <input @bind="newUser.Email" placeholder="Email" />
            <input @bind="newUser.Password" placeholder="Adgangskode" type="password" />
            <input @bind="newUser.Hotel" placeholder="Hotel" />
            <select @bind="newUser.Role">
                <option disabled selected>Vælg rolle</option>
                @foreach (var role in Roles)
                {
                    <option value="@role">@role</option>
                }
            </select>
            <select @bind="newUser.Status">
                <option disabled selected value="">Vælg status</option>
                <option value="Aktiv">Aktiv</option>
                <option value="Inaktiv">Inaktiv</option>
            </select>
            @if (newUser.Role == "Elev")
            {
                <select @bind="newUser.SchoolType">
                    <option disabled selected value="">Vælg skole</option>
                    <option value="EUX">EUX</option>
                    <option value="EUV">EUV</option>
                    <option value="Voksenelev">Voksenelev</option>
                    <option value="Ordinær">Ordinær</option>
                </select>
            }
            <button @onclick="SaveUserAsync">Gem</button>
            <button @onclick="CloseCreateModal">Luk</button>
            @if (!string.IsNullOrEmpty(createMessage))
            {
                <p>@createMessage</p>
            }
        </div>
    </div>
}

@code {
    private static readonly List<string> Roles = new() { "Elev", "Køkkenchef", "HR", "Kok" };
    private User? currentUser;
    private List<User> users = new();
    private List<string> hotels = new();
    
    // Filter state
    private string searchTerm = "";
    private string selectedRole = "";
    private string selectedHotel = "";
    
    // UI state
    private int? activeActionMenuUserId;
    private bool showCreateModal;
    
    // Create user state
    private User newUser = new();
    private string createMessage = "";

    private IEnumerable<User> FilteredUsers =>
        users.Where(u =>
            (string.IsNullOrEmpty(searchTerm) || u.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) &&
            (string.IsNullOrEmpty(selectedRole) || u.Role == selectedRole) &&
            (string.IsNullOrEmpty(selectedHotel) || u.Hotel == selectedHotel));

    protected override async Task OnInitializedAsync()
    {
        currentUser = await UserService.GetCurrentUserAsync();
        if (currentUser?.Role == "Elev")
        {
            Nav.NavigateTo("/");
            return;
        }

        users = await UserService.GetAllUsersAsync();
        hotels = users
            .Select(u => u.Hotel)
            .Where(h => !string.IsNullOrEmpty(h))
            .Distinct()
            .OrderBy(h => h)
            .ToList();
    }

    private void CreateUser()
    {
        showCreateModal = true;
        newUser = new();
        createMessage = "";
    }

    private void CloseCreateModal() => showCreateModal = false;

    private async Task SaveUserAsync()
    {
        var result = await UserService.CreateUserAsync(newUser);
        createMessage = result != null ? "Bruger oprettet!" : "Noget gik galt under oprettelsen";
        
        if (result != null)
        {
            users = await UserService.GetAllUsersAsync();
            showCreateModal = false;
        }
    }

    private async Task DeleteUserAsync(int userId)
    {
        if (currentUser?.Role == "HR" && await UserService.DeleteUserAsync(userId))
        {
            users = await UserService.GetAllUsersAsync();
        }
        activeActionMenuUserId = null;
    }

    private void ToggleActionMenu(int userId) =>
        activeActionMenuUserId = activeActionMenuUserId == userId ? null : userId;

    private static string GetInitials(string fullName)
    {
        var parts = fullName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length switch
        {
            0 => "",
            1 => parts[0][..1].ToUpper(),
            _ => $"{parts[0][..1]}{parts[^1][..1]}".ToUpper()
        };
    }
    
    private async Task ToggleUserStatusAsync(User user)
    {
        var newStatus = user.Status == "Aktiv" ? "Inaktiv" : "Aktiv";
        if (await UserService.UpdateUserStatusAsync(user.Id, newStatus))
        {
            users = await UserService.GetAllUsersAsync();
        }
        activeActionMenuUserId = null;
    }
}
