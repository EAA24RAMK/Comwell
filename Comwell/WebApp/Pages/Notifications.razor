@page "/notifikationer"
@inject HttpClient Http
@inject IUserService UserService
@inject INotificationService NotificationService
@inject NavigationManager Nav
@using Core.Models
@using WebApp.Services

<h3>Notifikationer</h3>

@if (notifications == null)
{
    <p>Indl√¶ser notifikationer...</p>
}
else if (!notifications.Any())
{
    <p>Du har ingen notifikationer.</p>
}
else
{
    <ul>
        @foreach (var note in notifications.OrderByDescending(n => n.CreatedAt))
        {
            <li style="margin-bottom: 1rem;">
                <strong>@(note.IsRead ? "" : "[NY] ")</strong>
                @note.Message <br />
                <small>Deadline: @note.Deadline.ToShortDateString() | Modtaget: @note.CreatedAt.ToShortDateString()</small><br />

                @if (note.PlanId != null && note.GoalId != null)
                {
                    <button class="btn btn-sm btn-outline-primary" @onclick="() => GoToGoal(note.PlanId.Value, note.GoalId.Value)">
                        üîó G√• til m√•l
                    </button>
                }
            </li>
        }
    </ul>
}

@code {
    private List<Notification> notifications = new();
    private User? currentUser;

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("‚û°Ô∏è OnInitializedAsync k√∏rer...");
        
        currentUser = await UserService.GetCurrentUserAsync();
        if (currentUser == null) 
            return;

        // Automatisk kald til backend for at generere nye notifikationer
        await Http.PostAsync("api/notification/generate", null);
        
        Console.WriteLine("‚û°Ô∏è Genererede notifikationer (POST sendt)");

        // Hent notifikationer for den aktuelle bruger
        notifications = await NotificationService.GetNotificationsByUserAsync(currentUser.Id);
    }
    
    private void GoToGoal(int planId, int goalId)
    {
        Nav.NavigateTo($"/elevplaner?planId={planId}&goalId={goalId}");
    }
}