@page "/posts"
@using WebApp.Services
@using Core.Models
@inject IUserService UserService
@inject IPostService PostService

@if (currentUser == null)
{
    <p><strong>Du skal være logget ind for at bruge opslagstavlen.</strong></p>
}
else
{
    <div class="posts-container">
        <h3>Opslagstavle</h3>

        <!-- Formular -->
        <div class="new-post-card">
            <input @bind="newPost.Title" placeholder="Titel" class="input-field" />
            <textarea @bind="newPost.Content" placeholder="Indhold" rows="4" class="textarea-field"></textarea>
            <button class="create-button" @onclick="CreatePost">Opret opslag</button>
        </div>

        <!-- Søgning -->
        <input @bind="searchTerm" @bind:event="oninput" placeholder="Søg efter titel eller indhold..." class="search-field" />

        <!-- Indlæg -->
        <div class="posts-list">
            @if (FilteredPosts.Any())
            {
                @foreach (var post in FilteredPosts.OrderByDescending(p => p.Id))
                {
                    <div class="post-card">
                        <div class="post-header">
                            <div class="post-author-avatar">@GetInitials(post.Author)</div>
                            <div class="post-meta">
                                <div class="post-title">@post.Title</div>
                                <div class="post-author">af @post.Author – @post.CreatedAt.ToString("dd MMM yyyy HH:mm")</div>
                            </div>
                            <button class="delete-button" @onclick="() => DeletePost(post.Id)">⋮</button>
                        </div>
                        <p class="post-content">@post.Content</p>
                    </div>
                }
            }
            else
            {
                <p>Ingen opslag matcher din søgning.</p>
            }
        </div>
    </div>
}
@code {
    private List<Post> posts = new();
    private Post newPost = new();
    private User? currentUser;
    private string searchTerm = "";

    protected override async Task OnInitializedAsync()
    {
        currentUser = await UserService.GetCurrentUserAsync();
        await LoadPosts();
    }

    private async Task LoadPosts()
    {
        posts = await PostService.GetAllPostsAsync();
    }

    private async Task CreatePost()
    {
        newPost.Author = currentUser?.Name ?? "Ukendt";
        newPost.CreatedAt = DateTime.Now;

        await PostService.CreatePostAsync(newPost);
        newPost = new(); // ryd formular

        await LoadPosts();
    }

    private async Task DeletePost(int id)
    {
        await PostService.DeletePostAsync(id);
        await LoadPosts();
    }

    private IEnumerable<Post> FilteredPosts =>
        string.IsNullOrWhiteSpace(searchTerm)
            ? posts
            : posts.Where(p =>
                (!string.IsNullOrEmpty(p.Title) && p.Title.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
                (!string.IsNullOrEmpty(p.Content) && p.Content.Contains(searchTerm, StringComparison.OrdinalIgnoreCase))
            );

    private string GetInitials(string? fullName)
    {
        if (string.IsNullOrWhiteSpace(fullName)) return "";
        var parts = fullName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return parts.Length == 1
            ? parts[0][0].ToString().ToUpper()
            : $"{parts[0][0]}{parts[^1][0]}".ToUpper();
    }
}
