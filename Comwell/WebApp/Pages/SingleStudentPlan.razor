@page "/elevplan"
@using WebApp.Services
@using Core.Models
@inject IStudentPlanService StudentPlanService
@inject IUserService UserService
@inject ITemplateService TemplateService
@inject NavigationManager Nav

@if (currentUser != null)
{
    <h3>@currentUser.Name elevplan</h3>
}
else
{
    <h3>Min elevplan</h3>
}

@if (plans == null || !plans.Any())
{
    <p>Ingen planer fundet.</p>
}
else
{
    @foreach (var plan in plans)
    {
        <div class="plan-box" style="margin-bottom: 2rem; border: 1px solid #ccc; padding: 1rem;">
            <h4>@templates.FirstOrDefault(t => t.Id == plan.TemplateId)?.Title</h4>
            <p><strong>Periode:</strong> @plan.PeriodStart.ToShortDateString() - @plan.PeriodEnd.ToShortDateString()</p>
            <p><strong>Oprettet af:</strong> @plan.CreatedBy</p>

            <button class="fold-toggle" @onclick="() => TogglePlan(plan.Id)">
                Mål @if (openPlanIds.Contains(plan.Id)) { <span>▼</span> } else { <span>▶</span> }
            </button>

            @if (openPlanIds.Contains(plan.Id))
            {
                @foreach (var goal in plan.Goals)
                {
                    <div style="margin-left: 1rem; margin-bottom: 1rem;">
                        <button class="fold-toggle" @onclick="() => ToggleGoal(goal.Id)">
                            <strong>@goal.Title</strong> - @GetGoalStatusText(goal)
                            @if (openGoalIds.Contains(goal.Id)) { <span>▼</span> } else { <span>▶</span> }
                        </button>

                        @if (openGoalIds.Contains(goal.Id))
                        {
                            <ul>
                                @foreach (var subtask in goal.Subtasks)
                                {
                                    <li>
                                        @subtask.Text

                                        @if (!subtask.IsCompleted)
                                        {
                                            @if (!subtask.IsRequestedCompleted)
                                            {
                                                <button class="btn btn-sm btn-outline-primary ms-2"
                                                        @onclick="() => RequestSubtaskCompletion(plan, goal, subtask)">
                                                    Anmod om 'fuldført'
                                                </button>
                                            }
                                            else
                                            {
                                                <button class="btn btn-sm btn-warning ms-2"
                                                        title="Fortryd anmodning"
                                                        @onclick="() => CancelSubtaskRequest(plan, goal, subtask)">
                                                    Anmodet (fortryd)
                                                </button>
                                            }
                                        }
                                        else
                                        {
                                            <span class="badge bg-success ms-2">Fuldført</span>
                                        }
                                    </li>
                                }
                            </ul>
                        }
                    </div>
                }
            }

            <h5>
                <button class="btn fold-toggle" @onclick="() => ToggleNotes(plan.Id)">
                    Noter @if (openNotePlanIds.Contains(plan.Id)) { <span>▼</span> } else { <span>▶</span> }
                </button>
            </h5>

            @if (openNotePlanIds.Contains(plan.Id))
            {
                @foreach (var note in plan.Notes)
                {
                    <div>
                        <em>@note.CreatedAt.ToShortDateString()</em>: @note.Text
                        <button class="btn btn-sm btn-outline-danger ms-2" @onclick="() => DeleteNote(plan, note.Id)">Slet</button>
                    </div>
                }

                @if (addingNoteForPlanId == plan.Id)
                {
                    <div>
                        <textarea class="form-control mb-2"
                                  @oninput="e => newNoteTexts[plan.Id] = e.Value?.ToString() ?? string.Empty">
                            @newNoteTexts.GetValueOrDefault(plan.Id, string.Empty)
                        </textarea>
                        <button @onclick="() => SaveNote(plan)">Gem note</button>
                        <button @onclick="CancelAddNote">Annuller</button>
                    </div>
                }
                else
                {
                    <button class="bi bi-plus" @onclick="() => StartAddNote(plan.Id)">
                        Tilføj note
                    </button>
                }
            }

            <hr />
        </div>
    }
}

@code {
    private List<StudentPlan> plans = new();
    private List<Template> templates = new();
    private User? currentUser;
    private HashSet<int> openPlanIds = new();
    private HashSet<int> openGoalIds = new();
    private HashSet<int> openNotePlanIds = new();

    private int addingNoteForPlanId = -1;
    private Dictionary<int, string> newNoteTexts = new();

    protected override async Task OnInitializedAsync()
    {
        currentUser = await UserService.GetCurrentUserAsync();
        if (currentUser is null) return;

        plans = await StudentPlanService.GetPlansByUserAsync(currentUser);
        templates = await TemplateService.GetAllTemplatesAsync();

        if (currentUser.Role != "Elev")
        {
            Nav.NavigateTo("/");
        }
    }

    private void TogglePlan(int planId)
    {
        if (!openPlanIds.Add(planId))
            openPlanIds.Remove(planId);
    }

    private void ToggleGoal(int goalId)
    {
        if (!openGoalIds.Add(goalId))
            openGoalIds.Remove(goalId);
    }

    private void ToggleNotes(int planId)
    {
        if (!openNotePlanIds.Add(planId))
            openNotePlanIds.Remove(planId);
    }

    private string GetGoalStatusText(Goal goal)
    {
        int total = goal.Subtasks.Count;
        int completed = goal.Subtasks.Count(s => s.IsCompleted);

        if (total == 0) return "Ingen delopgaver";
        if (completed == 0) return "Ikke startet";
        if (completed == total) return "Fuldført";
        return $"{completed}/{total} fuldført";
    }

    private async Task RequestSubtaskCompletion(StudentPlan plan, Goal goal, Subtask subtask)
    {
        subtask.IsRequestedCompleted = true;
        await StudentPlanService.UpdateStudentPlanAsync(plan);
        StateHasChanged();
    }

    private async Task CancelSubtaskRequest(StudentPlan plan, Goal goal, Subtask subtask)
    {
        subtask.IsRequestedCompleted = false;
        await StudentPlanService.UpdateStudentPlanAsync(plan);
        StateHasChanged();
    }

    private void StartAddNote(int planId)
    {
        addingNoteForPlanId = planId;
        if (!newNoteTexts.ContainsKey(planId))
        {
            newNoteTexts[planId] = string.Empty;
        }
    }

    private void CancelAddNote()
    {
        addingNoteForPlanId = -1;
    }

    private async Task SaveNote(StudentPlan plan)
    {
        if (!newNoteTexts.TryGetValue(plan.Id, out var noteText) || string.IsNullOrWhiteSpace(noteText))
            return;

        var newNote = new Note
        {
            Id = plan.Notes.Any() ? plan.Notes.Max(n => n.Id) + 1 : 1,
            Text = noteText.Trim(),
            CreatedAt = DateTime.Now
        };

        plan.Notes.Add(newNote);
        await StudentPlanService.UpdateStudentPlanAsync(plan);

        newNoteTexts[plan.Id] = string.Empty;
        addingNoteForPlanId = -1;
        StateHasChanged();
    }

    private async Task DeleteNote(StudentPlan plan, int noteId)
    {
        var planToUpdate = plans.FirstOrDefault(p => p.Id == plan.Id);
        if (planToUpdate == null) return;

        planToUpdate.Notes.RemoveAll(n => n.Id == noteId);
        await StudentPlanService.UpdateStudentPlanAsync(planToUpdate);

        plans = await StudentPlanService.GetPlansByUserAsync(currentUser!);
    }
}
